<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Система управления проектом - AI-ассистент для тендеров</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
            animation: fadeInDown 0.8s ease;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
        
        .header .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            margin-bottom: 5px;
        }
        
        .project-info {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        .project-info-item {
            font-size: 0.95rem;
            opacity: 0.85;
        }
        
        .server-status {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 10px 15px;
            border-radius: 20px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 1000;
        }
        
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #4caf50;
            animation: pulse 2s infinite;
        }
        
        .status-indicator.offline {
            background: #f44336;
            animation: none;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .controls {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .btn {
            background: white;
            color: #667eea;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            margin: 0 5px;
            transition: all 0.3s ease;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-primary {
            background: #4caf50;
            color: white;
        }
        
        .btn-danger {
            background: #ff4444;
            color: white;
        }
        
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
            animation: fadeInUp 0.8s ease;
        }
        
        .summary-card {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .summary-card h3 {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .summary-card .value {
            font-size: 2rem;
            font-weight: bold;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .summary-card .subtext {
            font-size: 0.85rem;
            color: #888;
            margin-top: 5px;
        }
        
        .stages-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 25px;
            animation: fadeIn 1s ease;
        }
        
        .stage-card {
            background: white;
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .stage-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.15);
        }
        
        .stage-delete {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 30px;
            height: 30px;
            background: #ff4444;
            color: white;
            border: none;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.2rem;
            opacity: 0.8;
            transition: all 0.3s ease;
        }
        
        .stage-delete:hover {
            opacity: 1;
            transform: rotate(90deg);
        }
        
        .stage-number {
            position: absolute;
            top: 15px;
            left: 15px;
            width: 35px;
            height: 35px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.1rem;
        }
        
        .stage-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            cursor: pointer;
            padding-left: 45px;
        }
        
        .stage-icon {
            width: 45px;
            height: 45px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
        }
        
        .stage-title {
            flex: 1;
            margin-left: 15px;
            padding-right: 40px;
        }
        
        .stage-title h3 {
            font-size: 1.15rem;
            color: #333;
            margin-bottom: 5px;
        }
        
        .status-selector {
            display: inline-block;
            margin-bottom: 5px;
        }
        
        .status-selector select {
            padding: 3px 10px;
            border-radius: 12px;
            border: 1px solid #ddd;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
        }
        
        .stage-title .weeks {
            display: inline-block;
            margin-left: 10px;
            font-size: 0.75rem;
            color: #777;
        }
        
        .expand-icon {
            width: 24px;
            height: 24px;
            cursor: pointer;
            transition: transform 0.3s ease;
            opacity: 0.6;
            position: absolute;
            right: 50px;
            top: 55px;
        }
        
        .expand-icon.expanded {
            transform: rotate(180deg);
        }
        
        .progress-container {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .circular-progress {
            position: relative;
            width: 100px;
            height: 100px;
        }
        
        .circular-progress svg {
            transform: rotate(-90deg);
        }
        
        .progress-value {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        .progress-details {
            flex: 1;
        }
        
        .progress-bar-linear {
            height: 8px;
            background: #f0f0f0;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        
        .progress-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 1s ease;
            background: linear-gradient(90deg, #667eea, #764ba2);
        }
        
        .stage-metrics {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 12px;
            margin-bottom: 15px;
        }
        
        .metric {
            text-align: center;
        }
        
        .metric-label {
            font-size: 0.75rem;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .metric-value {
            font-size: 1.1rem;
            font-weight: 600;
            color: #444;
            margin-top: 3px;
        }
        
        .stage-brief {
            color: #666;
            font-size: 0.9rem;
            line-height: 1.6;
            padding: 15px;
            background: #f0f3f6;
            border-radius: 10px;
            margin-bottom: 15px;
            position: relative;
            cursor: pointer;
        }
        
        .edit-icon {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            opacity: 0.5;
            cursor: pointer;
        }
        
        .edit-icon:hover {
            opacity: 1;
        }
        
        .stage-details {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease, opacity 0.3s ease;
            opacity: 0;
        }
        
        .stage-details.expanded {
            max-height: 2000px;
            opacity: 1;
        }
        
        .detail-section {
            border-top: 1px solid #eee;
            padding-top: 15px;
            margin-top: 15px;
        }
        
        .detail-section h4 {
            color: #444;
            font-size: 0.95rem;
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        .detail-section p {
            color: #666;
            font-size: 0.85rem;
            line-height: 1.6;
            margin-bottom: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            cursor: pointer;
            position: relative;
        }
        
        .tasks-list {
            list-style: none;
            padding: 0;
        }
        
        .task-item {
            display: flex;
            align-items: center;
            padding: 8px 0;
            position: relative;
        }
        
        .task-checkbox {
            width: 18px;
            height: 18px;
            margin-right: 10px;
            cursor: pointer;
        }
        
        .task-text {
            flex: 1;
            color: #555;
            font-size: 0.85rem;
            line-height: 1.6;
        }
        
        .task-text.completed {
            text-decoration: line-through;
            opacity: 0.6;
        }
        
        .task-delete {
            color: #ff4444;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.3s;
            margin-left: 10px;
        }
        
        .task-item:hover .task-delete {
            opacity: 0.7;
        }
        
        .task-delete:hover {
            opacity: 1 !important;
        }
        
        .add-task-container {
            margin-top: 10px;
            display: flex;
            gap: 10px;
        }
        
        .add-task-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 0.85rem;
        }
        
        .add-task-btn {
            padding: 8px 15px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .add-task-btn:hover {
            background: #5a67d8;
        }
        
        .payment-info {
            display: flex;
            justify-content: space-between;
            padding: 12px;
            background: #e8f5e9;
            border-radius: 8px;
            margin-top: 10px;
        }
        
        .payment-info span {
            font-size: 0.85rem;
            color: #2e7d32;
        }
        
        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s ease;
        }
        
        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background-color: white;
            border-radius: 20px;
            padding: 30px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }
        
        .modal-header h2 {
            color: #333;
            font-size: 1.5rem;
        }
        
        .modal-close {
            cursor: pointer;
            font-size: 1.5rem;
            color: #999;
            transition: color 0.3s;
        }
        
        .modal-close:hover {
            color: #333;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #666;
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 0.9rem;
            font-family: inherit;
        }
        
        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .icon-selector {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        
        .icon-option {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            cursor: pointer;
            border: 2px solid transparent;
            border-radius: 8px;
            transition: all 0.3s;
        }
        
        .icon-option:hover {
            background: #f0f0f0;
        }
        
        .icon-option.selected {
            border-color: #667eea;
            background: #667eea20;
        }
        
        .tasks-input-container {
            margin-bottom: 10px;
        }
        
        .task-input-item {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .task-input-item input {
            flex: 1;
        }
        
        .task-input-remove {
            padding: 8px 12px;
            background: #ff4444;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }
        
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 25px;
        }
        
        .loading {
            text-align: center;
            padding: 50px;
            color: white;
            font-size: 1.2rem;
        }
        
        .error-message {
            background: #ff5252;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes slideUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
    </style>
</head>
<body>
    <div class="server-status">
        <div class="status-indicator" id="serverStatus"></div>
        <span id="serverStatusText">Подключение...</span>
    </div>

    <div class="container">
        <div class="header">
            <h1>📊 Система управления проектом</h1>
            <div class="subtitle">AI-ассистент для автоматизации подготовки конкурсных заявок по 44‑ФЗ/223‑ФЗ</div>
            <div class="project-info">
                <div class="project-info-item">📅 Срок проекта: 12 недель</div>
                <div class="project-info-item">💰 Бюджет: <span id="totalBudget">1 700 000 ₽</span></div>
                <div class="project-info-item">⏱ Трудозатраты: <span id="totalHours">776</span> часов</div>
            </div>
        </div>
        
        <div class="controls">
            <button class="btn btn-primary" onclick="showCreateStageModal()">➕ Создать этап</button>
            <button class="btn" onclick="exportData()">📥 Экспорт данных</button>
            <button class="btn" onclick="document.getElementById('importFile').click()">📤 Импорт данных</button>
            <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(this)">
            <button class="btn" onclick="showStats()">📊 Статистика</button>
            <button class="btn btn-danger" onclick="resetData()">🔄 Сбросить данные</button>
        </div>
        
        <div class="summary-cards">
            <div class="summary-card">
                <h3>Общий прогресс</h3>
                <div class="value" id="overall-progress">0%</div>
                <div class="subtext">Выполнено работ</div>
            </div>
            <div class="summary-card">
                <h3>Этапы завершены</h3>
                <div class="value" id="stages-complete">0 из 0</div>
                <div class="subtext">Полностью готовы</div>
            </div>
            <div class="summary-card">
                <h3>В работе</h3>
                <div class="value" id="stages-progress">0</div>
                <div class="subtext">Активные этапы</div>
            </div>
            <div class="summary-card">
                <h3>Часов отработано</h3>
                <div class="value" id="hours-worked">0</div>
                <div class="subtext">из <span id="totalHoursText">0</span> часов</div>
            </div>
        </div>
        
        <div id="stagesContainer" class="stages-grid">
            <div class="loading">Загрузка данных...</div>
        </div>
    </div>
    
    <!-- Modal for creating new stage -->
    <div id="createStageModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Создать новый этап</h2>
                <span class="modal-close" onclick="closeCreateStageModal()">✕</span>
            </div>
            
            <div class="form-group">
                <label for="stageName">Название этапа *</label>
                <input type="text" id="stageName" placeholder="Например: Разработка модуля">
            </div>
            
            <div class="form-group">
                <label for="stageIcon">Иконка</label>
                <div class="icon-selector" id="iconSelector">
                    <div class="icon-option selected" data-icon="📋">📋</div>
                    <div class="icon-option" data-icon="💻">💻</div>
                    <div class="icon-option" data-icon="🔧">🔧</div>
                    <div class="icon-option" data-icon="📊">📊</div>
                    <div class="icon-option" data-icon="🚀">🚀</div>
                    <div class="icon-option" data-icon="🔍">🔍</div>
                    <div class="icon-option" data-icon="⚙️">⚙️</div>
                    <div class="icon-option" data-icon="📈">📈</div>
                    <div class="icon-option" data-icon="💡">💡</div>
                    <div class="icon-option" data-icon="🎯">🎯</div>
                </div>
            </div>
            
            <div class="form-group">
                <label for="stageWeeks">Сроки *</label>
                <input type="text" id="stageWeeks" placeholder="Например: Недели 1-2">
            </div>
            
            <div class="form-group">
                <label for="stageHours">Часы *</label>
                <input type="number" id="stageHours" placeholder="Количество часов">
            </div>
            
            <div class="form-group">
                <label for="stageCost">Стоимость (₽) *</label>
                <input type="number" id="stageCost" placeholder="Стоимость в рублях">
            </div>
            
            <div class="form-group">
                <label for="stageBrief">Ключевой результат *</label>
                <input type="text" id="stageBrief" placeholder="Краткое описание результата">
            </div>
            
            <div class="form-group">
                <label for="stageDescription">Описание *</label>
                <textarea id="stageDescription" placeholder="Подробное описание этапа"></textarea>
            </div>
            
            <div class="form-group">
                <label>Задачи этапа</label>
                <div class="tasks-input-container" id="tasksInputContainer">
                    <div class="task-input-item">
                        <input type="text" placeholder="Задача 1">
                    </div>
                </div>
                <button class="btn" onclick="addTaskInput()">+ Добавить задачу</button>
            </div>
            
            <div class="modal-footer">
                <button class="btn" onclick="closeCreateStageModal()">Отмена</button>
                <button class="btn btn-primary" onclick="createStage()">Создать этап</button>
            </div>
        </div>
    </div>
    
    <script>
        const API_URL = 'http://localhost:3000/api';
        let stages = [];
        let expandedStages = new Set();
        let selectedIcon = '📋';
        
        // Check server connection
        async function checkServerConnection() {
            try {
                const response = await fetch(API_URL + '/stages');
                if (response.ok) {
                    document.getElementById('serverStatus').classList.remove('offline');
                    document.getElementById('serverStatusText').textContent = 'Подключено к БД';
                    return true;
                }
            } catch (error) {
                document.getElementById('serverStatus').classList.add('offline');
                document.getElementById('serverStatusText').textContent = 'Сервер недоступен';
                return false;
            }
        }
        
        // Load stages from server
        async function loadStages() {
            try {
                const response = await fetch(API_URL + '/stages');
                if (!response.ok) throw new Error('Failed to fetch stages');
                
                stages = await response.json();
                renderStages();
                updateStats();
                updateTotals();
            } catch (error) {
                console.error('Error loading stages:', error);
                document.getElementById('stagesContainer').innerHTML = 
                    '<div class="error-message">Ошибка загрузки данных. Проверьте подключение к серверу.</div>';
            }
        }
        
        // Update totals
        function updateTotals() {
            const totalHours = stages.reduce((sum, stage) => sum + (stage.hours || 0), 0);
            const totalCost = stages.reduce((sum, stage) => sum + (stage.cost || 0), 0);
            
            document.getElementById('totalHours').textContent = totalHours;
            document.getElementById('totalHoursText').textContent = totalHours;
            document.getElementById('totalBudget').textContent = formatCurrency(totalCost);
        }
        
        // Show create stage modal
        function showCreateStageModal() {
            document.getElementById('createStageModal').classList.add('show');
            // Reset form
            document.getElementById('stageName').value = '';
            document.getElementById('stageWeeks').value = '';
            document.getElementById('stageHours').value = '';
            document.getElementById('stageCost').value = '';
            document.getElementById('stageBrief').value = '';
            document.getElementById('stageDescription').value = '';
            
            // Reset tasks
            document.getElementById('tasksInputContainer').innerHTML = `
                <div class="task-input-item">
                    <input type="text" placeholder="Задача 1">
                </div>
            `;
            
            // Reset icon selection
            document.querySelectorAll('.icon-option').forEach(option => {
                option.classList.remove('selected');
            });
            document.querySelector('.icon-option[data-icon="📋"]').classList.add('selected');
            selectedIcon = '📋';
        }
        
        // Close create stage modal
        function closeCreateStageModal() {
            document.getElementById('createStageModal').classList.remove('show');
        }
        
        // Icon selection
        document.querySelectorAll('.icon-option').forEach(option => {
            option.addEventListener('click', function() {
                document.querySelectorAll('.icon-option').forEach(opt => opt.classList.remove('selected'));
                this.classList.add('selected');
                selectedIcon = this.dataset.icon;
            });
        });
        
        // Add task input
        function addTaskInput() {
            const container = document.getElementById('tasksInputContainer');
            const taskCount = container.children.length + 1;
            const taskDiv = document.createElement('div');
            taskDiv.className = 'task-input-item';
            taskDiv.innerHTML = `
                <input type="text" placeholder="Задача ${taskCount}">
                <button class="task-input-remove" onclick="this.parentElement.remove()">✕</button>
            `;
            container.appendChild(taskDiv);
        }
        
        // Create stage
        async function createStage() {
            const name = document.getElementById('stageName').value.trim();
            const weeks = document.getElementById('stageWeeks').value.trim();
            const hours = parseInt(document.getElementById('stageHours').value) || 0;
            const cost = parseInt(document.getElementById('stageCost').value) || 0;
            const brief = document.getElementById('stageBrief').value.trim();
            const description = document.getElementById('stageDescription').value.trim();
            
            // Validate required fields
            if (!name || !weeks || !hours || !cost || !brief || !description) {
                alert('Пожалуйста, заполните все обязательные поля');
                return;
            }
            
            // Collect tasks
            const tasks = [];
            document.querySelectorAll('#tasksInputContainer input').forEach(input => {
                const taskText = input.value.trim();
                if (taskText) tasks.push(taskText);
            });
            
            try {
                const response = await fetch(API_URL + '/stages', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name,
                        icon: selectedIcon,
                        weeks,
                        hours,
                        cost,
                        brief,
                        description,
                        tasks
                    })
                });
                
                if (!response.ok) throw new Error('Failed to create stage');
                
                closeCreateStageModal();
                await loadStages();
            } catch (error) {
                console.error('Error creating stage:', error);
                alert('Ошибка при создании этапа');
            }
        }
        
        // Delete stage
        async function deleteStage(stageId) {
            if (!confirm('Вы уверены, что хотите удалить этот этап? Все задачи этапа также будут удалены.')) {
                return;
            }
            
            try {
                const response = await fetch(API_URL + '/stages/' + stageId, {
                    method: 'DELETE'
                });
                
                if (!response.ok) throw new Error('Failed to delete stage');
                
                await loadStages();
            } catch (error) {
                console.error('Error deleting stage:', error);
                alert('Ошибка при удалении этапа');
            }
        }
        
        // Update stage
        async function updateStage(id, data) {
            try {
                const response = await fetch(API_URL + '/stages/' + id, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                if (!response.ok) throw new Error('Failed to update stage');
                await loadStages();
            } catch (error) {
                console.error('Error updating stage:', error);
                alert('Ошибка при обновлении этапа');
            }
        }
        
        // Toggle task
        async function toggleTask(taskId, stageIndex) {
            try {
                const response = await fetch(API_URL + '/tasks/' + taskId + '/toggle', {
                    method: 'PUT'
                });
                
                if (!response.ok) throw new Error('Failed to toggle task');
                
                const result = await response.json();
                
                // Update local data
                const task = stages[stageIndex].tasks.find(t => t.id === taskId);
                if (task) {
                    task.completed = result.completed;
                }
                
                // Update progress
                updateStageProgress(stageIndex);
                
                // Update UI without full reload
                const checkbox = document.querySelector(`#task-checkbox-${taskId}`);
                const taskText = document.querySelector(`#task-text-${taskId}`);
                if (checkbox) checkbox.checked = result.completed;
                if (taskText) {
                    if (result.completed) {
                        taskText.classList.add('completed');
                    } else {
                        taskText.classList.remove('completed');
                    }
                }
            } catch (error) {
                console.error('Error toggling task:', error);
            }
        }
        
        // Add task
        async function addTask(stageId, stageIndex) {
            const input = document.getElementById(`add-task-${stageId}`);
            const text = input.value.trim();
            
            if (!text) return;
            
            try {
                const response = await fetch(API_URL + '/stages/' + stageId + '/tasks', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text })
                });
                
                if (!response.ok) throw new Error('Failed to add task');
                
                const newTask = await response.json();
                
                // Update local data
                stages[stageIndex].tasks.push(newTask);
                
                // Clear input
                input.value = '';
                
                // Update progress
                updateStageProgress(stageIndex);
                
                // Render only tasks list
                renderTasksList(stageId, stageIndex);
            } catch (error) {
                console.error('Error adding task:', error);
            }
        }
        
        // Delete task
        async function deleteTask(taskId, stageIndex) {
            if (!confirm('Удалить эту задачу?')) return;
            
            try {
                const response = await fetch(API_URL + '/tasks/' + taskId, {
                    method: 'DELETE'
                });
                
                if (!response.ok) throw new Error('Failed to delete task');
                
                // Update local data
                const taskIndex = stages[stageIndex].tasks.findIndex(t => t.id === taskId);
                if (taskIndex !== -1) {
                    stages[stageIndex].tasks.splice(taskIndex, 1);
                }
                
                // Update progress
                updateStageProgress(stageIndex);
                
                // Render only tasks list
                const stageId = stages[stageIndex].id;
                renderTasksList(stageId, stageIndex);
            } catch (error) {
                console.error('Error deleting task:', error);
            }
        }
        
        // Update stage progress
        function updateStageProgress(stageIndex) {
            const stage = stages[stageIndex];
            const completedTasks = stage.tasks.filter(t => t.completed).length;
            const totalTasks = stage.tasks.length;
            
            const progress = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
            stage.progress = progress;
            
            // Update server
            updateStage(stage.id, { progress });
            
            // Update UI
            updateProgressDisplay(stage.id, stageIndex);
            updateStats();
        }
        
        // Update progress display
        function updateProgressDisplay(stageId, stageIndex) {
            const stage = stages[stageIndex];
            const progress = stage.progress || 0;
            const color = getStatusColor(stage.status);
            
            // Update circular progress
            const circular = document.querySelector(`#circular-${stageId}`);
            if (circular) {
                circular.innerHTML = createCircularProgress(progress, color);
            }
            
            // Update linear progress
            const progressFill = document.querySelector(`#progress-fill-${stageId}`);
            if (progressFill) {
                progressFill.style.width = progress + '%';
            }
            
            // Update text
            const progressText = document.querySelector(`#progress-text-${stageId}`);
            if (progressText) {
                progressText.textContent = `Выполнено: ${progress}%`;
            }
            
            // Update metric
            const metricProgress = document.querySelector(`#metric-progress-${stageId}`);
            if (metricProgress) {
                metricProgress.textContent = progress + '%';
            }
        }
        
        // Render tasks list
        function renderTasksList(stageId, stageIndex) {
            const container = document.querySelector(`#tasks-container-${stageId}`);
            if (!container) return;
            
            const stage = stages[stageIndex];
            const tasksHtml = stage.tasks.map(task => `
                <div class="task-item">
                    <input type="checkbox" 
                           id="task-checkbox-${task.id}"
                           class="task-checkbox" 
                           ${task.completed ? 'checked' : ''}
                           onchange="toggleTask(${task.id}, ${stageIndex})">
                    <span id="task-text-${task.id}" 
                          class="task-text ${task.completed ? 'completed' : ''}">${task.text}</span>
                    <span class="task-delete" onclick="deleteTask(${task.id}, ${stageIndex})">✕</span>
                </div>
            `).join('');
            
            container.innerHTML = tasksHtml;
        }
        
        // Get status color
        function getStatusColor(status) {
            switch(status) {
                case 'complete': return '#4caf50';
                case 'progress': return '#ff9800';
                case 'pending': return '#f44336';
                case 'testing': return '#03a9f4';
                default: return '#999';
            }
        }
        
        // Create circular progress
        function createCircularProgress(progress, color) {
            const radius = 40;
            const circumference = 2 * Math.PI * radius;
            const strokeDashoffset = circumference - (progress / 100) * circumference;
            
            return `
                <svg width="100" height="100">
                    <circle cx="50" cy="50" r="${radius}" fill="none" stroke="#f0f0f0" stroke-width="8"/>
                    <circle cx="50" cy="50" r="${radius}" fill="none" stroke="${color}" stroke-width="8"
                            stroke-dasharray="${circumference}" stroke-dashoffset="${strokeDashoffset}"
                            stroke-linecap="round" style="transition: stroke-dashoffset 1s ease;"/>
                </svg>
                <div class="progress-value" style="color: ${color}">${progress}%</div>
            `;
        }
        
        // Toggle details
        function toggleDetails(stageId) {
            const details = document.getElementById(`details-${stageId}`);
            const icon = document.getElementById(`expand-${stageId}`);
            
            if (expandedStages.has(stageId)) {
                expandedStages.delete(stageId);
                details.classList.remove('expanded');
                icon.classList.remove('expanded');
            } else {
                expandedStages.add(stageId);
                details.classList.add('expanded');
                icon.classList.add('expanded');
            }
        }
        
        // Edit field
        function editField(stageId, field, currentValue) {
            const newValue = prompt(`Редактировать ${field === 'brief' ? 'ключевой результат' : 'описание'}:`, currentValue);
            if (newValue && newValue !== currentValue) {
                const data = {};
                data[field] = newValue;
                updateStage(stageId, data);
            }
        }
        
        // Change status
        function changeStatus(stageId, newStatus) {
            updateStage(stageId, { status: newStatus });
        }
        
        // Render stages
        function renderStages() {
            const container = document.getElementById('stagesContainer');
            
            if (stages.length === 0) {
                container.innerHTML = '<div class="loading">Нет этапов. Создайте первый этап!</div>';
                return;
            }
            
            container.innerHTML = stages.map((stage, index) => {
                const color = getStatusColor(stage.status);
                const isExpanded = expandedStages.has(stage.id);
                
                return `
                    <div class="stage-card">
                        <button class="stage-delete" onclick="deleteStage(${stage.id})" title="Удалить этап">✕</button>
                        <div class="stage-number">${stage.number}</div>
                        
                        <div class="stage-header" onclick="toggleDetails(${stage.id})">
                            <div class="stage-icon" style="background: ${color}20;">
                                ${stage.icon}
                            </div>
                            <div class="stage-title">
                                <h3>${stage.name}</h3>
                                <div class="status-selector" onclick="event.stopPropagation()">
                                    <select onchange="changeStatus(${stage.id}, this.value)" 
                                            style="background: ${color}20; color: ${color}">
                                        <option value="pending" ${stage.status === 'pending' ? 'selected' : ''}>Не начат</option>
                                        <option value="progress" ${stage.status === 'progress' ? 'selected' : ''}>В работе</option>
                                        <option value="testing" ${stage.status === 'testing' ? 'selected' : ''}>Тестирование</option>
                                        <option value="complete" ${stage.status === 'complete' ? 'selected' : ''}>Завершен</option>
                                    </select>
                                </div>
                                <span class="weeks">${stage.weeks}</span>
                            </div>
                        </div>
                        
                        <svg class="expand-icon ${isExpanded ? 'expanded' : ''}" id="expand-${stage.id}" 
                             xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" 
                             stroke="currentColor" stroke-width="2">
                            <polyline points="6 9 12 15 18 9"></polyline>
                        </svg>
                        
                        <div class="stage-metrics">
                            <div class="metric">
                                <div class="metric-label">Часы</div>
                                <div class="metric-value">${stage.hours}ч</div>
                            </div>
                            <div class="metric">
                                <div class="metric-label">Стоимость</div>
                                <div class="metric-value">${formatCurrency(stage.cost)}</div>
                            </div>
                            <div class="metric">
                                <div class="metric-label">Прогресс</div>
                                <div class="metric-value" id="metric-progress-${stage.id}">${stage.progress || 0}%</div>
                            </div>
                        </div>
                        
                        <div class="progress-container">
                            <div class="circular-progress" id="circular-${stage.id}">
                                ${createCircularProgress(stage.progress || 0, color)}
                            </div>
                            <div class="progress-details">
                                <div class="progress-bar-linear">
                                    <div class="progress-fill" id="progress-fill-${stage.id}" 
                                         style="width: ${stage.progress || 0}%; background: ${color};"></div>
                                </div>
                                <small style="color: #999;" id="progress-text-${stage.id}">
                                    Выполнено: ${stage.progress || 0}%
                                </small>
                            </div>
                        </div>
                        
                        <div class="stage-brief" onclick="editField(${stage.id}, 'brief', '${stage.brief.replace(/'/g, "\\'")}')">
                            <strong>Ключевой результат:</strong> ${stage.brief}
                            <span class="edit-icon">✏️</span>
                        </div>
                        
                        <div class="stage-details ${isExpanded ? 'expanded' : ''}" id="details-${stage.id}">
                            <div class="detail-section">
                                <h4>📋 Описание этапа</h4>
                                <p onclick="editField(${stage.id}, 'description', '${stage.description.replace(/'/g, "\\'")}')">
                                    ${stage.description}
                                    <span class="edit-icon">✏️</span>
                                </p>
                            </div>
                            
                            <div class="detail-section">
                                <h4>📝 Задачи этапа</h4>
                                <div class="tasks-list" id="tasks-container-${stage.id}">
                                    ${stage.tasks.map(task => `
                                        <div class="task-item">
                                            <input type="checkbox" 
                                                   id="task-checkbox-${task.id}"
                                                   class="task-checkbox" 
                                                   ${task.completed ? 'checked' : ''}
                                                   onchange="toggleTask(${task.id}, ${index})">
                                            <span id="task-text-${task.id}" 
                                                  class="task-text ${task.completed ? 'completed' : ''}">${task.text}</span>
                                            <span class="task-delete" onclick="deleteTask(${task.id}, ${index})">✕</span>
                                        </div>
                                    `).join('')}
                                </div>
                                <div class="add-task-container">
                                    <input type="text" 
                                           class="add-task-input" 
                                           id="add-task-${stage.id}"
                                           placeholder="Новая задача..."
                                           onkeypress="if(event.key==='Enter') addTask(${stage.id}, ${index})">
                                    <button class="add-task-btn" onclick="addTask(${stage.id}, ${index})">Добавить</button>
                                </div>
                            </div>
                            
                            <div class="detail-section">
                                <h4>💰 Схема оплаты</h4>
                                <div class="payment-info">
                                    <span>Аванс (50%): ${formatCurrency(Math.round(stage.cost * 0.5))}</span>
                                    <span>По завершении (50%): ${formatCurrency(stage.cost - Math.round(stage.cost * 0.5))}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Format currency
        function formatCurrency(amount) {
            return new Intl.NumberFormat('ru-RU').format(amount) + ' ₽';
        }
        
        // Update statistics
        async function updateStats() {
            try {
                const response = await fetch(API_URL + '/stats');
                const stats = await response.json();
                
                document.getElementById('overall-progress').textContent = 
                    Math.round(stats.avg_progress || 0) + '%';
                document.getElementById('stages-complete').textContent = 
                    `${stats.completed || 0} из ${stats.total_stages || 0}`;
                document.getElementById('stages-progress').textContent = 
                    stats.in_progress || 0;
                document.getElementById('hours-worked').textContent = 
                    Math.round(stats.hours_worked || 0);
            } catch (error) {
                console.error('Error updating stats:', error);
            }
        }
        
        // Export data
        async function exportData() {
            try {
                const response = await fetch(API_URL + '/export');
                const data = await response.json();
                
                const dataStr = JSON.stringify(data, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                
                const exportFileDefaultName = 'project_stages_' + new Date().toISOString().split('T')[0] + '.json';
                
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
            } catch (error) {
                console.error('Error exporting data:', error);
                alert('Ошибка при экспорте данных');
            }
        }
        
        // Import data
        async function importData(input) {
            const file = input.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    const response = await fetch(API_URL + '/import', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                    
                    if (!response.ok) throw new Error('Failed to import data');
                    
                    alert('Данные успешно импортированы!');
                    await loadStages();
                } catch (error) {
                    console.error('Error importing data:', error);
                    alert('Ошибка при импорте данных');
                }
            };
            reader.readAsText(file);
            
            // Reset input
            input.value = '';
        }
        
        // Reset data
        async function resetData() {
            if (!confirm('Вы уверены, что хотите сбросить все данные к исходному состоянию?')) return;
            
            try {
                const response = await fetch(API_URL + '/reset', {
                    method: 'POST'
                });
                
                if (!response.ok) throw new Error('Failed to reset data');
                
                alert('Данные сброшены к исходному состоянию!');
                await loadStages();
            } catch (error) {
                console.error('Error resetting data:', error);
                alert('Ошибка при сбросе данных');
            }
        }
        
        // Show statistics
        async function showStats() {
            try {
                const response = await fetch(API_URL + '/stats');
                const stats = await response.json();
                
                const message = `
📊 Статистика проекта:
━━━━━━━━━━━━━━━━━━━
Всего этапов: ${stats.total_stages}
Завершено: ${stats.completed}
В работе: ${stats.in_progress}
Тестирование: ${stats.testing}
Не начато: ${stats.pending}

Средний прогресс: ${Math.round(stats.avg_progress || 0)}%
Часов отработано: ${Math.round(stats.hours_worked || 0)} из ${stats.total_hours}

Всего задач: ${stats.total_tasks}
Выполнено задач: ${stats.completed_tasks}
                `;
                
                alert(message);
            } catch (error) {
                console.error('Error showing stats:', error);
                alert('Ошибка при получении статистики');
            }
        }
        
        // Initialize
        async function init() {
            const connected = await checkServerConnection();
            if (connected) {
                await loadStages();
                
                // Check connection every 5 seconds
                setInterval(checkServerConnection, 5000);
            }
        }
        
        // Start application
        init();
    </script>
</body>
</html>
